# ΑΝΤΡΕΪ-ΑΝΤΡΙΑΝ ΠΡΕΝΤΑ

	$ make
	$ ./fs N L λ
	$ make clean

 + N: σύνολο πελατών
 + L: σύνολο αιτημάτων ανά πελάτη
 + λ: παράμετρος εκθετικής κατανομής (εκθετικά κατανεμημένος χρόνος ανά κάθε αίτημα)

Το πρόγραμμα προσομοιώνει εξυπηρετητή αρχείων και ταυτόχρονα αιτήματα από πελάτες προς αυτόν. Για
την εργασία αυτή, τα συνολικά αρχεία από τα οποία μπορούν να διαλέξουν οι πελάτες είναι K=10. Κάθε
αρχείο έχει 10 γραμμές, με μέγιστο αριθμό χαρακτήρων ανά γραμμή 128 (10x128).


Ο file server (FS) αρχικά δημιουργεί την κύρια κοινή μνήμη, η οποία αποτελείται από έναν buffer
μεγέθους SIZE. Στον buffer αυτόν στέλνονται αιτήματα από πελάτες και διαβάζονται από τον FS. Ο FS
επίσης δημιουργεί 3 semaphores:

	-SEMSV: Ο FS περιμένει αίτημα από πελάτη πρωτού διαβάσει από τον buffer, δηλαδή ελέγχει αν ο
		buffer είναι άδειος ώστε να μην προκληθεί υποχείληση. Αρχικοποιείται με 0, αφού αρχικά
		ο buffer δεν κρατάει κανένα αίτημα.
	-SEMCL: Ο πελάτης περιμένει να αδειάσει τουλάχιστον ένας κόμβος από τον buffer πρωτού στείλει
		αίτημα, δηλαδή ελέγχει αν ο buffer είναι γεμάτος ώστε να μην προκληθεί υπερχείληση.
		Αρχικοποιείται με SIZE, αφού αρχικά ο buffer είναι άδειος.
	-MUTX:  Κοινός mutex που χρησιμοποιείται από τον FS και πελάτες πριν προσπελάσουν τον buffer,
		που είναι κοινή μνήμη. Αποφεύγονται τα race conditions.

Αφού δημιουργήσει τα παιδιά, δηλαδή τους πελάτες, ξεκινάει τον ρόλο του ως FS.

<br>
Κάθε πελάτης κατά τη δημιουργία του πρώτα διαλέγει τυχαία γραμμή αρχής, τέλους ανάκτησης και
φτιάχνει την δική του κοινή μνήμη και semaphore, τα οποία θα μοιραστεί μόνο με τον FS. Το μέγεθος
της κοινής μνήμης ισούται με το σύνολο γραμμών που επιθυμεί ο πελάτης (from-to+1 blocks) επί το
μέγιστο αριθμό χαρακτήρων ανά γραμμή (128).
Επιλέγει τυχαία ένα από τα διαθέσιμα αρχεία και πριν στείλει αίτημα, μειώνει τον SEMCL κατά 1, με
την έννοια ότι ένας από τους διαθέσιμους χώρους του buffer έχει ληφθεί.

	-Αν SEMCL == 0, τότε όσοι πελάτες θέλουν να στείλουν αίτημα θα πρέπει να περιμένουν μέχρι ο
			FS να διαλέξει ένα από τα αιτήματα από τον buffer να εξυπηρετήσει.
	-Αν SEMCL > 0, μειώνεται κατά 1 και ο πελάτης στέλνει κανονικά το αίτημά του.

Αφού στείλει αίτημα, ο πελάτης αυξάνει τον SEMSV κατά 1, με την έννοια ότι ο FS έχει ένα νέο αίτημα
διαθέσιμο. Πριν προχωρήσει, περιμένει με την χρήση του δικού του semaphore πρώτα να τελειώσει ο FS
με την ολοκλήρωση της απάντησης, ώστε να μην κλείσει την κοινή μνήμη πρώορα. Όταν τελειώσει ο
FS και σηματοδοτήσει το αντίστοιχο semaphore, ο πελάτης καταγράφει την καθυστέρηση του FS και σβήνει
την κοινή μνήμη του. Αυτό επαναλαμβάνεται L φορές.


<br>
Ο FS, καθώς βρίσκεται σε βρόχο, αρχικά μειώνει τον SEMSV κατά 1, με την έννοια ότι ένας πελάτης θα
εξυπηρετηθεί και στον buffer υπάρχει νέος διαθέσιμος χώρος για νέο αίτημα.
	
	-Αν SEMSV == 0, σημαίνει ότι ο buffer είναι άδειος και ο FS θα πρέπει να περιμένει αίτημα
	    από κάποιον πελάτη.
	-Αν SEMSV > 0, μειώνεται κατά 1 και ο FS ξεκινάει την εξυπηρέτησή του.

Αφού SEMSV > 0, σημαίνει ότι υπάρχει τουλάχιστον ένας πελάτης που περιμένει απάντηση. Οπότε, ο FS
δημιουργεί νέο νήμα ειδικό για την εξυπηρέτηση του πελάτη. Αφού το νήμα ξεκινήσει με το αίτημα του
πελάτη, αυξάνει το SEMCL κατά 1 και η παλιά θέση του στον buffer είναι διαθέσιμη για οποιοδήποτε
νέο αίτημα. Το σύνολο των αιτημάτων είναι εξαρχής γνωστός, οπότε ο FS επαναλαμβάνει τη διαδικασία
αυτή N*L φορές.

<br>
Τέλος, ο FS περιμένει τα νήματα που δεν έχουν ολοκληρώσει την εκτέλεσή τους και αποδεσμεύει την
κοινή μνήμη του και τα semaphores.

<br>
<br>

## ΔΟΜΕΣ/ΤΥΠΟΙ ΔΕΔΟΜΕΝΩΝ

Ο buffer είναι δομή ουρά, δηλαδή ακολουθεί την αρχή FIFO. Αποτελείται από:
	
	-start: θέση του πρώτου αιτήματος
	-end:   ελεύθερη θέση για το επόμενο αίτημα
	-node:  τύπος δεδομένων που κρατάει πληροφορία για τον πελάτη. Συγκεκριμένα, όνομα της κοινής
	        μνήμης, αρχείου και το semaphore του. Επίσης κρατάει την αρχική και τελική γραμμή
	        ανάκτησης.

Ο buffer έχει SIZE συνολικά nodes. Μετά την τελευταία θέση, η τοποθέτηση των νέων αιτημάτων ξεκινάει
πάλι από την πρώτη θέση.

Ο record κρατάει στατιστικά του πελάτη σχετικά με τις συνολικές γραμμές που ζήτησε, πλήθος
αρχείον κ.ο.κ., τα οποία ο πελάτης x ανεβάζει στο αρχείο ans'x' κατά τον τερματισμό του.


<br>
<br>

## ΣΥΝΑΡΤΗΣΕΙΣ

Η send_request χρησιμοποιείται από τους πελάτες για να αποθηκεύσουν στην ελεύθεσρη θέση του buffer τα
στοιχεία τους, απαραίτητα για τον FS να ολοκληρώσει την απάντηση.


Η read_request χρησιμοποιείται από τα νήματα του FS, όπου διαλέγουν το αίτημα του πελάτη που
βρίσκεται στη θέση end του buffer. Έχοντας πρόσβαση στη κοινή μνήμη του πελάτη και στο αρχείο που
διάλεξε, με τη χρήση της fgets το νήμα στέλνει τις επιθυμιτές γραμμές. Έπειτα ανοίγει το semaphore
του συγκεκριμένου πελάτη ώστε να τον σηματοδοτήσει για την ολοκλήρωση του αιτήματος.


<br>
<br>

## ΕΠΙΠΛΕΟΝ ΠΛΗΡΟΦΟΡΙΕΣ

- Οι semaphores MUTX και SEMCL είναι δηλωμένοι στο fs.h ώστε όλα τα αρχεία να έχουν πρόσβαση σε αυτούς

- Για μεγάλο αριθμό πελατών/αιτημάτων, το πρόγραμμα τερματίζει λόγου ότι πάρα πολλά αρχεία είναι
ανοιχτά. Το όριο είναι περίπου 100 πελάτες, 40 αιτήματα σε προσωπικό υπολογιστή και περίπου 50 με 30
σε σύστηµα Linux.

- Στην αρχή του προγράμματος, υπάρχει unlink και για κοινή μνήμη, και για semaphore, σε περίπτωση που
το πρόγραμμα τερματίσει με error και μείνου ανοιχτά sem/κοινή μνήμη.



